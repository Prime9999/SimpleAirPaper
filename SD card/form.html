<!DOCTYPE HTML PUBLIC "ISO/IEC 15445:2000//DTD HTML//EN">
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=480">
<style>
body {
	font-family: sans-serif;
	font-size: large;
}
canvas {
	border-style: groove;
}
.button-label {
  display: inline-block;
  margin: 1em 0;
  padding: .7em 1em;
  line-height: 1.4;
  background: #ffffff;
  color: #000000;
  font-size: 0.95em;
  border-radius: 2.5em;
  border-style: solid;
}
.button-label:active {
  background: #3e8bff;
  color: #ffffff;
}
.button-label input {
  display: none;
}
.button-label button {
  display: none;
}
</style>
<title>Upload to M5Paper</title>
</head>
<body>

<p id="message">Select image and push upload</p>
<label class="button-label" id="file-label">Select Image
<input type="file" id="file" accept="image/*" oninput="fileSelected()">
</label>
<label class="button-label" id="upload-label" style="visibility: hidden;">Upload
<button id="upload" onclick="upload()">Upload</button>
</label>
<br />
<canvas id="canvas" width="960" height="540", style="width:480px;"></canvas>

<script type="text/javascript">
var file = null;
var blob = null;
const MAX_WIDTH = 960;
const MAX_HEIGHT = 540;
function fileSelected() {
	file = document.getElementById("file").files[0];
	document.getElementById("upload-label").style.visibility = "visible";
	
	var image = new Image();
	var reader = new FileReader();
	
	reader.onload = () => {
		image.src = reader.result;
	}
	
	image.onload = () => {
		var x = 0, y = 0, width, height;
		if (image.width > image.height) {
			var ratio = image.height / image.width;
			width = MAX_WIDTH;
			height = MAX_WIDTH * ratio;
			y = (MAX_HEIGHT - height) / 2;
		} else {
			var ratio = image.width / image.height;
			width = MAX_HEIGHT * ratio;
			height = MAX_HEIGHT;
			x = (MAX_WIDTH - width) / 2;
		}
		var canvas = document.getElementById("canvas");
		var context = canvas.getContext('2d');
		context.clearRect(0,0,MAX_WIDTH,MAX_HEIGHT);
		context.drawImage(image,
          0, 0, image.width, image.height,
          x, y, width, height
        );
        var base64 = canvas.toDataURL('image/png');
        
        var barr, bin, i, len;
        bin = atob(base64.split('base64,')[1]);
        len = bin.length;
        barr = new Uint8Array(len);
        i = 0;
        while (i < len) {
          barr[i] = bin.charCodeAt(i);
          i++;
        }
        blob = new Blob([barr], {type: 'image/png'});
	}
	reader.readAsDataURL(file);
}
function upload() {
	if (blob != null) {
		document.getElementById("message").innerText = "Uploading..."
		var request = new XMLHttpRequest();
		request.open("POST", document.URL, true);
		request.onload = function (oEvent) {
			document.getElementById("message").innerText = "Uploaded successfully!"
		};
		request.send(blob);
	}
}
</script>

</body>
</html>